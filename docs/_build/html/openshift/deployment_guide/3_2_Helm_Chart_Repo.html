

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Section 3.2 - Setting up the Helm Chart Repository &mdash; SDP Reference Architectures  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ECS on EC2" href="../../ecs-ec2/deployment_guide/index.html" />
    <link rel="prev" title="Section 3.1 - Creating the Application Environments" href="3_1_Application_Environments.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SDP Reference Architectures
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Reference Architectures</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">OpenShift</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1_0_Deploy_Tools_Overview.html">Section 1 - Deploying the DevOps Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_1_Prepare_To_Install.html">Section 1.1 - Preparing to Run the Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_2_Run_Installer.html">Section 1.2 - Running the Installer Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_0_Pipeline_Config_Overview.html">Section 2 - Setting Up a Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_1_Pipeline_Planning.html">Section 2.1 - Pipeline Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_2_Pipeline_Config.html">Section 2.2 - Creating the Pipeline Configuration Repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_0_Application_Environment_Overview.html">Section 3 - Setting up the Application Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_1_Application_Environments.html">Section 3.1 - Creating the Application Environments</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Section 3.2 - Setting up the Helm Chart Repository</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ecs-ec2/deployment_guide/index.html">ECS on EC2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecs-fargate/deployment_guide/index.html">ECS on FarGate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/deployment_guide/index.html">Vanilla Kubernetes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SDP Reference Architectures</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">OpenShift</a> &raquo;</li>
        
      <li>Section 3.2 - Setting up the Helm Chart Repository</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/openshift/deployment_guide/3_2_Helm_Chart_Repo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="section-3-2-setting-up-the-helm-chart-repository">
<h1>Section 3.2 - Setting up the Helm Chart Repository<a class="headerlink" href="#section-3-2-setting-up-the-helm-chart-repository" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>To achieve disaster recovery, auditability, rollbacks, and infrastructure as
code, the OpenShift library deploys applications using Helm from a chart stored
in a GitHub repository.</p>
<p><a href="https://helm.sh/" target="_blank">Helm</a> is a tool for templating and managing Kubernetes configuration files and,
by extension, OpenShift configuration files. Any element in OpenShift can be expressed as
as yaml or JSON. Helm lets you take that yaml and organize it, turn them into
a template, and, through tiller, use them to deploy to your cluster.</p>
<p>This Helm chart repository is what the <a href="/sdp-docs/pages/libraries/openshift/README.html" target="_blank">OpenShift SDP library</a> will use to
deploy your application to OpenShift. In it, you should create a Helm chart that
defines the various <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/deployments/how_deployments_work.html" target="_blank">DeploymentConfigs</a>, <a href="https://docs.openshift.com/container-platform/3.11/architecture/core_concepts/pods_and_services.html#services" target="_blank">Services</a>, <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/routes.html" target="_blank">Routes</a>, and other objects
your application needs to function.</p>
</div>
<div class="section" id="create-a-repository">
<h2>Create a Repository<a class="headerlink" href="#create-a-repository" title="Permalink to this headline">¶</a></h2>
<p>Use an SCM like GitHub to create a repository to store your Helm chart. This way
you can access, share and maintain the Helm chart like any other piece of code.
Name it whatever you like, but helm-configuration-repository makes sense.
It can be public or private, so long as the GitHub account Jenkins is using
can read from it and write back to it.</p>
</div>
<div class="section" id="initialize-the-helm-repository">
<h2>Initialize The Helm Repository<a class="headerlink" href="#initialize-the-helm-repository" title="Permalink to this headline">¶</a></h2>
<p>Assuming you’ve created an empty GitHub repository for your helm chart, you can run:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">create</span> <span class="o">&lt;</span><span class="n">repo_name</span><span class="o">&gt;</span>
<span class="n">cd</span> <span class="o">&lt;</span><span class="n">repo_name</span><span class="o">&gt;</span>
<span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">origin</span> <span class="o">&lt;</span><span class="n">helm</span> <span class="n">repo</span> <span class="n">url</span><span class="o">&gt;</span>
<span class="n">git</span> <span class="n">add</span> <span class="o">--</span><span class="nb">all</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;initializing chart repo&quot;</span>
<span class="n">git</span> <span class="n">push</span> <span class="o">-</span><span class="n">u</span> <span class="n">origin</span> <span class="n">master</span>
</pre></div>
</div>
<p>Once that’s done you should</p>
<ol class="arabic simple">
<li>Delete the yaml files that were automatically created when <code class="docutils literal"><span class="pre">helm</span> <span class="pre">create</span></code> was called. These are example helm templates, and we don’t need them.</li>
<li>Delete the contents of templates/_helpers.tpl and templates/NOTES.txt. We want to keep those files, but provide our own content.</li>
<li>Update <em>Chart.yaml</em> to properly describe your new chart.</li>
</ol>
<p>For more information on Helm charts, check out the <a href="#id2"><span class="problematic" id="id3">|Helm_documentation|</span></a>.</p>
</div>
<div class="section" id="sdp-helm-conventions">
<h2>SDP Helm Conventions<a class="headerlink" href="#sdp-helm-conventions" title="Permalink to this headline">¶</a></h2>
<p>SDP pushes and pulls to this chart repository to keep it up to date with the
image tags of deployed containers.</p>
<p>For each application repository that SDP will be building, add a key under
<code class="docutils literal"><span class="pre">image_shas</span></code> in <em>values.yaml</em>. If there is no <code class="docutils literal"><span class="pre">image_shas</span></code> key, create one.</p>
<p>As an example, if there was a repository called <code class="docutils literal"><span class="pre">sample-app</span></code>, your
<code class="docutils literal"><span class="pre">values.yaml</span></code> would include:</p>
<div class="highlight-YAML"><div class="highlight"><pre><span></span><span class="nt">image_shas</span><span class="p">:</span>
    <span class="nt">sample_app</span><span class="p">:</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Because YAML key’s cannot contain hyphens, the openshift converts them to
underscores and expects that value under image_shas</p>
</div>
<p>Your template would then be able to specify the image for a deployment via:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="o">-</span><span class="n">registry</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">sample</span><span class="o">-</span><span class="n">app</span><span class="p">:{{</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">image_shas</span><span class="o">.</span><span class="n">sample_app</span> <span class="p">}}</span>
</pre></div>
</div>
<p>At this point, you should take some time to finish fleshing out your Helm chart
to reflect how you wish to deploy your app.</p>
</div>
<div class="section" id="information-on-writing-templates">
<h2>Information on Writing Templates<a class="headerlink" href="#information-on-writing-templates" title="Permalink to this headline">¶</a></h2>
<p>The Helm documentation on writing <a href="https://docs.helm.sh/developing_charts/" target="_blank">charts</a> and <a href="https://docs.helm.sh/chart_template_guide/" target="_blank">templates</a> is a good place
to start learning how to create your helm chart. There are a few additional tips
that are useful for writing charts and templates for OpenShift.</p>
<p>The first useful tip is that it’s possible to create objects in OpenShift using
the web console, and then view its corresponding yaml file either by using the
“edit YAML” option or using the OpenShift CLI. The challenge is identifying and
deleting fields that are automatically generated by the cluster or added by
default. This removes unnecessary clutter from the template and, in the case of
automatically generated fields such as the <code class="docutils literal"><span class="pre">resourceVersion</span></code>, prevents errors
in the cluster.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ oc get all -o yaml
</pre></div>
</div>
<p>The second useful tip, which mostly applies if you are copying YAML files from
OpenShift, is that the <code class="docutils literal"><span class="pre">apiVersion</span></code> field for OpenShift-exclusive object
types need to be modified for Helm to process the template correctly. Below is
a table from an <a href="https://blog.openshift.com/getting-started-helm-openshift/" target="_blank">OpenShift blog post</a> mapping the object types, <code class="docutils literal"><span class="pre">Kind</span></code>, to the
appropriate <code class="docutils literal"><span class="pre">apiVersion</span></code>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">apiVersion</th>
<th class="head">Kind</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>apps.openshift.io/v1</td>
<td>DeploymentConfig</td>
</tr>
<tr class="row-odd"><td>authorization.openshift.io/v1, rbac/v1beta1*</td>
<td>ClusterRole</td>
</tr>
<tr class="row-even"><td>authorization.openshift.io/v1, rbac/v1beta1*</td>
<td>ClusterRoleBinding</td>
</tr>
<tr class="row-odd"><td>authorization.openshift.io/v1, rbac/v1beta1*</td>
<td>Role</td>
</tr>
<tr class="row-even"><td>authorization.openshift.io/v1, rbac/v1beta1*</td>
<td>RoleBinding</td>
</tr>
<tr class="row-odd"><td>build.openshift.io/v1</td>
<td>Build</td>
</tr>
<tr class="row-even"><td>build.openshift.io/v1</td>
<td>BuildConfig</td>
</tr>
<tr class="row-odd"><td>image.openshift.io/v1</td>
<td>Image</td>
</tr>
<tr class="row-even"><td>image.openshift.io/v1</td>
<td>ImageStream</td>
</tr>
<tr class="row-odd"><td>project.openshift.io/v1</td>
<td>Project</td>
</tr>
<tr class="row-even"><td>route.openshift.io/v1</td>
<td>Route</td>
</tr>
<tr class="row-odd"><td>template.openshift.io/v1</td>
<td>Template</td>
</tr>
<tr class="row-even"><td>user.openshift.io/v1</td>
<td>Group</td>
</tr>
<tr class="row-odd"><td>user.openshift.io/v1</td>
<td>User</td>
</tr>
</tbody>
</table>
<p>The third tip is knowing that each container being deployed likely needs at least
three things: a DeploymentConfig, a Service, and a Route. The DeploymentConfig
manages creating and running the container, the Service makes it possible to connect
to that container within the cluster, and the Route exposes that service so it can
be connected to from outside the cluster. You can see example templates for each
of these in the <a href="https://github.com/boozallen/sdp-helm-chart" target="_blank">sdp-helm-chart</a> repository, which is itself a Helm chart.</p>
</div>
<div class="section" id="add-the-values-files">
<h2>Add The Values Files<a class="headerlink" href="#add-the-values-files" title="Permalink to this headline">¶</a></h2>
<p>In addition to the <em>values.yaml</em> file created when <code class="docutils literal"><span class="pre">helm</span> <span class="pre">create</span></code> was run, you
need a <em>values.&lt;APP_ENV&gt;.yaml</em> file for each application environment you
created when running <em>provision_app_envs.sh</em>. Be sure to substitute <em>&lt;APP_ENV&gt;</em>
with the “short_name” of the application environment. For example, if you created a
<em>dev</em> and <em>prod</em> environment, you might create those files with the command:</p>
<p>The purpose of these separate files is so that you can provide separate
configurations (database URLs, names, etc.) for different environments. Now,
whenever you use the <code class="docutils literal"><span class="pre">deploy_to</span> <span class="pre">dev</span></code> step in your pipeline, it will deploy a
helm chart using <em>values.dev.yaml</em>.</p>
<p>The SDP will automatically update the image sha value discussed earlier, but you
should now modify the different values files with their environment-specifc
variables.</p>
</div>
<div class="section" id="updating-the-pipeline-configuration">
<h2>Updating the Pipeline Configuration<a class="headerlink" href="#updating-the-pipeline-configuration" title="Permalink to this headline">¶</a></h2>
<p>If you recall from earlier in this guide, in the page on the
<a href="/sdp-docs/pages/deployment-guides/openshift/2_2_Pipeline_Config.html" target="_blank">Pipeline Configuration Repository</a>, there were some settings for the
<a href="/sdp-docs/pages/libraries/openshift/README.html" target="_blank">OpenShift SDP library</a> that may not have been clear before this point in the
guide.</p>
<div class="highlight-groovy"><div class="highlight"><pre><span></span><span class="n">libraries</span><span class="o">{</span>
  <span class="c1">//...</span>
  <span class="n">openshift</span><span class="o">{</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://my-openshift-cluster.ocp.example.com:8443&quot;</span>
    <span class="n">helm_configuration_repository</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/kottoson-bah/sdp-example-helm-config.git&quot;</span>
    <span class="n">helm_configuration_repository_credential</span> <span class="o">=</span> <span class="n">github</span>
    <span class="n">tiller_namespace</span> <span class="o">=</span> <span class="n">my</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">tiller</span>
    <span class="n">tiller_credential</span> <span class="o">=</span> <span class="n">my</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">tiller</span><span class="o">-</span><span class="n">credential</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Here’s what you should now put for each of these settings</p>
<table border="1" class="docutils" id="id1">
<caption><span class="caption-text">Provisioned OpenShift Infrastructure</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>url</td>
<td>The master URL of your OpenShift cluster i.e. the one you use to log in</td>
</tr>
<tr class="row-odd"><td>helm_configuration_repository</td>
<td>The URL for your helm configuration repository i.e. the one you use to clone it using https</td>
</tr>
<tr class="row-even"><td>helm_configuration_repository_credential</td>
<td>The ID of the username/password credential in Jenkins that can be used to read to and write from your helm repository</td>
</tr>
<tr class="row-odd"><td>tiller_namespace</td>
<td>The OpenShift namespace/project hosting the tiller server (e.g. demo-tiller)</td>
</tr>
<tr class="row-even"><td>tiller_credential</td>
<td>The credential for the tiller server you created in the previous section (e.g. demo-tiller)</td>
</tr>
</tbody>
</table>
<p>Also, if you haven’t already, update the application environments in your
pipeline config file to reflect the application environments you have just
deployed.</p>
</div>
<div class="section" id="closing-summary">
<h2>Closing Summary<a class="headerlink" href="#closing-summary" title="Permalink to this headline">¶</a></h2>
<p>In order to enable automatic deployments to OpenShift, this guide covered the
following:</p>
<ol class="arabic simple">
<li>Setting up Application Environments on OpenShift using <a href="https://github.com/boozallen/sdp-helm-chart/blob/master/resources/helm/provision_app_envs.sh" target="_blank">provision_app_envs.sh</a></li>
<li>Creating a Helm chart repository that defines how to deploy your application</li>
<li>Modifying Jenkins and the pipeline config file to use the helm chart repository and the provisioned application environments</li>
</ol>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a href="/sdp-docs/pages/how-to/helm-multitenancy.html" target="_blank">More on Helm multitenancy in OpenShift</a></li>
<li><a href="/sdp-docs/pages/libraries/openshift/README.html" target="_blank">More on the OpenShift SDP library</a></li>
<li><a href="https://docs.helm.sh/developing_charts/" target="_blank">More on writing Helm charts</a></li>
<li><a href="https://github.com/kottoson-bah/sdp-example-helm-config" target="_blank">example Helm chart</a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../ecs-ec2/deployment_guide/index.html" class="btn btn-neutral float-right" title="ECS on EC2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="3_1_Application_Environments.html" class="btn btn-neutral float-left" title="Section 3.1 - Creating the Application Environments" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>