####Jenkins Nested Template for SDP-Master 
####Missing Requirements
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  SDPCluster:
    Type: String
  JenkinsTG:
    Type: String
  JenkinsAgentTG:
    Type: String
  DNSName: 
    Type: String
  NLBDNSName:
    Type: String
  SDPExecutionRole:
    Type: String
Resources:
  JenkinsMasterTskDefn:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      RequiresCompatibilities:
        - 'EC2'
      ContainerDefinitions:
        - 
          Name: 'jenkins-master-container'
          Image: '495692436021.dkr.ecr.us-east-1.amazonaws.com/ecs-sdp:jenkins-master'
          Cpu: '2048'
          Memory: '3072'
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              HostPort: 8080
            - ContainerPort: 50000
              HostPort: 50000
          Environment:
            - Name: 'JENKINS_OPTS'
              Value: '--prefix=/jenkins'
      ExecutionRoleArn: !Ref SDPExecutionRole
      Memory: '3072'
      NetworkMode: 'bridge'
      TaskRoleArn: !Ref SDPExecutionRole
  JenkinsAgentTskDefn:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      RequiresCompatibilities:
        - 'EC2'
      ContainerDefinitions:
        - 
          Name: 'jenkins_agent-container'
          Image: '495692436021.dkr.ecr.us-east-1.amazonaws.com/ecs-sdp:jenkins-agent'
          Cpu: '2048'
          Memory: '3072'
          Essential: true
          Environment:
            - Name: 'EXECUTORS'
              Value: '1'
            - Name: 'JENKINS_PASSWORD'
              Value: 'admin'
            - Name: 'JENKINS_USERNAME'
              Value: 'admin'
            - Name: 'JENKINS_URL'
              Value: !Sub 'http://${DNSName}/jenkins'
            - Name: 'JENKINS_TUNNEL'
              Value: !Sub '${NLBDNSName}:50000'
          Privileged: True
      ExecutionRoleArn: !Ref SDPExecutionRole
      Memory: '3072'
      NetworkMode: 'bridge'
      TaskRoleArn: !Ref SDPExecutionRole
  JenkinsMasterservice:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref 'SDPCluster'
      DesiredCount: '1'
      TaskDefinition: !Ref JenkinsMasterTskDefn
      LoadBalancers:
        - ContainerName: jenkins-master-container
          ContainerPort: '8080'
          TargetGroupArn: !Ref JenkinsTG
        - ContainerName: jenkins-master-container
          ContainerPort: '50000'
          TargetGroupArn: !Ref JenkinsAgentTG
    DependsOn:
      - JenkinsMasterTskDefn
  JenkinsAgentservice:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref 'SDPCluster'
      DesiredCount: '1'
      TaskDefinition: !Ref JenkinsAgentTskDefn
    DependsOn:
      - JenkinsMasterService